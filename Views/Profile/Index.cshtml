@model EventDeneme.Models.users
@{
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<link rel="stylesheet" href="~/Content/profile.css">
<section class="profile-section">
    <div class="profile-box">

        <div class="toggle-buttons">
            <button id="profileBtn" class="active">Profile</button>
            <button id="passwordBtn">Change Password</button>
            <button id="mytickets">My Tickets</button>
            <button id="refunds">Refund Requests</button>
        </div>

        <div id="profileContent">
            <h1>Account Information</h1>

            @using (Html.BeginForm("UpdateProfile", "Profile", FormMethod.Post))
            {
                <label>First Name</label>
                <input type="text" name="Name" value="@Model.name" required>

                <label>Last Name</label>
                <input type="text" name="Surname" value="@Model.surname" required>

                <label>Email</label>
                <input type="email" value="@Model.email" disabled>

                <label>Phone</label>
                <input type="text" value="@Model.phone" disabled>

                <div class="form-buttons">
                    <button type="submit">Save Changes</button>
                    <a href="/Register/Logout">Logout</a>
                </div>

            }
            @if (TempData["ProfileSuccess"] != null)
            {
                <p style="margin-top:15px;">
                    @TempData["ProfileSuccess"]
                </p>
            }

        </div>
        <div id="passwordContent" class="hidden">
            @using (Html.BeginForm("ChangePassword", "Profile", FormMethod.Post))
            {
                <h1>Change Password</h1>
                <label>Old Password*</label>
                <input type="password" name="OldPassword" required>

                <label>New Password*</label>
                <input type="password" name="NewPassword" required>

                <label>New Password (repeat)</label>
                <input type="password" name="ConfirmPassword" required>

                <div class="form-buttons">
                    <button type="submit">Update</button>
                </div>
            }
        </div>
        <div id="ticketsContent" class="hidden">
            <h1>My Tickets</h1>
            @{
                var tickets = ViewBag.MyTickets as System.Collections.Generic.List<EventDeneme.Models.UserTicketViewModel>;
            }

            @if (tickets == null || !tickets.Any())
            {
                <p>Your tickets will be listed here once you make a purchase.</p>
            }
            else
            {
                <div class="ticket-list" style="display: flex; flex-direction: column; gap: 20px; margin-top: 20px;">
                    @foreach (var ticket in tickets)
                    {
                        <a href="@Url.Action("Details", "Ticket", new { id = ticket.TicketId })" style="text-decoration:none; color:inherit;">
                            <div class="ticket-card" style="border: 1px solid #ddd; padding: 20px; border-radius: 10px; display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; background: #fff; box-shadow: 0 4px 10px rgba(0,0,0,0.05); cursor:pointer;">
                                <div class="ticket-info" style="flex: 1; min-width: 300px;">
                                    <h3 style="margin: 0 0 10px 0; color: #d22;">@ticket.EventTitle</h3>
                                    <p style="margin: 0; color: #555; line-height: 1.6;">
                                        <strong>Date:</strong> @ticket.Date.ToString("dd MMMM yyyy HH:mm") <br />
                                        <strong>Venue:</strong> @ticket.Venue <br />
                                        <strong>Seat:</strong> @ticket.SeatLabel <br />
                                        <strong>Price:</strong> @ticket.Price.ToString("C2") <br />
                                        <strong>Holder:</strong> @ticket.HolderName
                                    </p>
                                </div>
                                <div class="ticket-actions" style="text-align: center; padding: 10px;">
                                    <img src="@ticket.QrUrl" alt="QR Code" style="width: 100px; height: 100px; display: block; margin: 0 auto 10px auto;" />
                                    <span style="background: #f0f0f0; padding: 5px 10px; border-radius: 4px; font-family: monospace; border: 1px solid #ccc; font-weight: bold;">@ticket.TicketCode</span>
                                    @{
                                        var statusColor = ticket.Status != null && ticket.Status.ToLower() == "refunded"
                                            ? "#d22"
                                            : "green";
                                    }
                                    <div style="margin-top: 5px; color: @statusColor; font-size: 0.9em; font-weight: bold;">@ticket.Status.ToUpper()</div>
                                </div>
                            </div>
                        </a>
                    }
                </div>
            }
        </div>

        <div id="refundsContent" class="hidden">
            <h1>Refund Requests</h1>
            @{
                var refunds = ViewBag.MyRefunds as System.Collections.Generic.List<EventDeneme.Models.UserRefundViewModel>;
            }

            @if (refunds == null || !refunds.Any())
            {
                <p>You have no refund requests.</p>
            }
            else
            {
                <table class="table" style="width:100%; margin-top:15px;">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Amount</th>
                            <th>Status</th>
                            <th>Requested At</th>
                            <th>Processed At</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var r in refunds)
                        {
                            <tr>
                                <td>@r.RefundId</td>
                                <td>@r.Amount.ToString("C2")</td>
                                <td>@r.Status</td>
                                <td>@(r.RequestedAt.HasValue ? r.RequestedAt.Value.ToString("dd MMM yyyy HH:mm") : "-")</td>
                                <td>@(r.ProcessedAt.HasValue ? r.ProcessedAt.Value.ToString("dd MMM yyyy HH:mm") : "-")</td>
                            </tr>
                        }
                    </tbody>
                </table>
            }
        </div>

    </div>
</section>

<script>
    const profileBtn = document.getElementById('profileBtn');
    const passwordBtn = document.getElementById('passwordBtn');
    const myTicketsBtn = document.getElementById('mytickets');
    const refundsBtn = document.getElementById('refunds');

    const profileContent = document.getElementById('profileContent');
    const passwordContent = document.getElementById('passwordContent');
    const refundsContent = document.getElementById('refundsContent');
    const ticketsContent = document.getElementById('ticketsContent');

    function hideAll() {
        profileContent.classList.add("hidden");
        passwordContent.classList.add("hidden");
        refundsContent.classList.add("hidden");
        ticketsContent.classList.add("hidden");

        profileBtn.classList.remove("active");
        passwordBtn.classList.remove("active");
        myTicketsBtn.classList.remove("active");
        refundsBtn.classList.remove("active");
    }

    profileBtn.addEventListener('click', () => {
        hideAll();
        profileContent.classList.remove("hidden");
        profileBtn.classList.add("active");
        history.pushState(null, '', '/Profile');
    });

    passwordBtn.addEventListener('click', () => {
        hideAll();
        passwordContent.classList.remove("hidden");
        passwordBtn.classList.add("active");
        history.pushState(null, '', '/Profile/ChangePassword');
    });

    
    refundsBtn.addEventListener('click', () => {
        window.location.href = '/Profile/Refunds';
    });

    /* ?? MY TICKETS – SERVER TARAFINDAN VERÝ YÜKLENSÝN DÝYE TAM SAYFA GEÇÝÞ */
    myTicketsBtn.addEventListener('click', () => {
        window.location.href = '/Profile/MyTickets';
    });

    /* ?? BACK / FORWARD SUPPORT */
    
    (function initTabFromUrl() {
        const path = window.location.pathname;
        hideAll();
        if (path.includes('MyTickets')) {
            ticketsContent.classList.remove("hidden");
            myTicketsBtn.classList.add("active");
        } else if (path.includes('ChangePassword')) {
            passwordContent.classList.remove("hidden");
            passwordBtn.classList.add("active");
        } else if (path.includes('Refunds')) {
            refundsContent.classList.remove("hidden");
            refundsBtn.classList.add("active");
        } else {
            profileContent.classList.remove("hidden");
            profileBtn.classList.add("active");
        }
    })();
</script>

